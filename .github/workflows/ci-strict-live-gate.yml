name: CI Strict Live Gate

on:
  schedule:
    - cron: "15 0 * * *"
  workflow_dispatch:

jobs:
  strict_live_gate:
    runs-on: [self-hosted, windows]
    timeout-minutes: 90
    outputs:
      manual_approval_required: ${{ steps.extract_manual_approval.outputs.manual_approval_required }}
      manual_approval_scope: ${{ steps.extract_manual_approval.outputs.manual_approval_scope }}
      manual_approval_environment: ${{ steps.extract_manual_approval.outputs.manual_approval_environment }}
    env:
      UPBIT_ACCESS_KEY: ${{ secrets.UPBIT_ACCESS_KEY }}
      UPBIT_SECRET_KEY: ${{ secrets.UPBIT_SECRET_KEY }}
      STRICT_LIVE_ACTION_EXECUTION_POLICY: safe-auto-execute

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Secrets
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace($env:UPBIT_ACCESS_KEY) -or [string]::IsNullOrWhiteSpace($env:UPBIT_SECRET_KEY)) {
            throw "UPBIT_ACCESS_KEY / UPBIT_SECRET_KEY secrets are required for strict live gate."
          }

      - name: Resolve Tooling
        shell: pwsh
        run: |
          $cmakeCmd = Get-Command cmake -ErrorAction SilentlyContinue
          if ($cmakeCmd) {
            $cmakePath = $cmakeCmd.Source
          } else {
            $fallback = "D:\\MyApps\\vcpkg\\downloads\\tools\\cmake-3.31.10-windows\\cmake-3.31.10-windows-x86_64\\bin\\cmake.exe"
            if (-not (Test-Path $fallback)) {
              throw "cmake is not available in PATH and fallback path is missing: $fallback"
            }
            $cmakePath = $fallback
          }
          "CMAKE_BIN=$cmakePath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          $vcpkgRoot = "D:\\MyApps\\vcpkg"
          if (Test-Path $vcpkgRoot) {
            "VCPKG_ROOT=$vcpkgRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }

      - name: Configure
        shell: pwsh
        run: '& "$env:CMAKE_BIN" -S . -B build -G "Visual Studio 17 2022" -A x64'

      - name: Build Release
        shell: pwsh
        run: '& "$env:CMAKE_BIN" --build build --config Release'

      - name: Run Unit Tests
        shell: pwsh
        run: |
          .\build\Release\AutoLifeExecutionStateTest.exe
          .\build\Release\AutoLifeTest.exe
          .\build\Release\AutoLifeStateTest.exe
          .\build\Release\AutoLifeEventJournalTest.exe

      - name: Run Strict Operational Gate (Live Probe + Parity)
        shell: pwsh
        run: |
          python scripts\run_ci_operational_gate.py -IncludeBacktest -RunLiveProbe -StrictExecutionParity

      - name: Generate Strict Live Trend + Alert Reports
        if: always()
        shell: pwsh
        run: |
          python scripts\generate_strict_live_gate_trend_alert.py -GateProfile strict_live -ApplyTunedThresholds -ActionExecutionPolicy "$env:STRICT_LIVE_ACTION_EXECUTION_POLICY" -EnableActionFeedbackLoop

      - name: Extract Manual Approval Requirement
        id: extract_manual_approval
        if: always()
        shell: pwsh
        run: |
          $reportPath = "build/Release/logs/strict_live_gate_action_response_report.json"
          $manualApprovalRequired = "false"
          $manualApprovalScope = "none"
          $manualApprovalEnvironment = "none"

          if (Test-Path $reportPath) {
            try {
              $report = Get-Content -Raw $reportPath | ConvertFrom-Json -ErrorAction Stop
              $required = $false
              try {
                $required = [bool]$report.manual_approval.approval_required_for_resume
              } catch {
                $required = $false
              }
              if ($required) {
                $manualApprovalRequired = "true"
              }

              $scopeCandidate = [string]$report.manual_approval.approval_scope
              if (-not [string]::IsNullOrWhiteSpace($scopeCandidate)) {
                $manualApprovalScope = $scopeCandidate
              }

              $environmentCandidate = [string]$report.manual_approval.github_environment.name
              if (-not [string]::IsNullOrWhiteSpace($environmentCandidate) -and $environmentCandidate -ne "none") {
                $manualApprovalEnvironment = $environmentCandidate
              } elseif ($manualApprovalRequired -eq "true") {
                $manualApprovalEnvironment = "strict-live-resume"
              }
            } catch {
              Write-Host "Manual approval extraction fallback applied: $($_.Exception.Message)"
            }
          } else {
            Write-Host "Action response report missing. Manual approval output defaults will be used."
          }

          "manual_approval_required=$manualApprovalRequired" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "manual_approval_scope=$manualApprovalScope" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "manual_approval_environment=$manualApprovalEnvironment" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload Gate Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strict-live-gate-reports
          path: |
            build/Release/logs/*.json
            build/Release/logs/*.csv
            build/Release/logs/*.log
            build/Release/state/*.json
            build/Release/state/*.jsonl

  strict_live_resume_approval_gate:
    needs: strict_live_gate
    if: ${{ always() && needs.strict_live_gate.outputs.manual_approval_required == 'true' }}
    runs-on: [self-hosted, windows]
    environment:
      name: ${{ needs.strict_live_gate.outputs.manual_approval_environment }}
    steps:
      - name: Approval Gate Passed
        shell: pwsh
        run: |
          Write-Host "Manual approval gate passed."
          Write-Host "approval_scope=${{ needs.strict_live_gate.outputs.manual_approval_scope }}"
          Write-Host "environment=${{ needs.strict_live_gate.outputs.manual_approval_environment }}"

  strict_live_resume_auto_path:
    needs: strict_live_gate
    if: ${{ always() && needs.strict_live_gate.outputs.manual_approval_required != 'true' }}
    runs-on: [self-hosted, windows]
    steps:
      - name: Resume Approval Not Required
        shell: pwsh
        run: |
          Write-Host "No manual approval required for strict live schedule resume."
