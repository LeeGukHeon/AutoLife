name: CI PR Gate

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

jobs:
  pr_gate:
    runs-on: [self-hosted, windows]
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve Tooling
        shell: powershell
        run: |
          $cmakeCmd = Get-Command cmake -ErrorAction SilentlyContinue
          if ($cmakeCmd) {
            $cmakePath = $cmakeCmd.Source
          } else {
            $fallback = "D:\\MyApps\\vcpkg\\downloads\\tools\\cmake-3.31.10-windows\\cmake-3.31.10-windows-x86_64\\bin\\cmake.exe"
            if (-not (Test-Path $fallback)) {
              throw "cmake is not available in PATH and fallback path is missing: $fallback"
            }
            $cmakePath = $fallback
          }
          "CMAKE_BIN=$cmakePath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          $vcpkgRoot = "D:\\MyApps\\vcpkg"
          if (Test-Path $vcpkgRoot) {
            "VCPKG_ROOT=$vcpkgRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }

      - name: Configure
        shell: powershell
        run: '& "$env:CMAKE_BIN" -S . -B build -G "Visual Studio 17 2022" -A x64'

      - name: Build Release
        shell: powershell
        run: '& "$env:CMAKE_BIN" --build build --config Release'

      - name: Run Unit Tests
        shell: powershell
        run: |
          .\build\Release\AutoLifeExecutionStateTest.exe
          .\build\Release\AutoLifeTest.exe
          .\build\Release\AutoLifeStateTest.exe
          .\build\Release\AutoLifeEventJournalTest.exe

      - name: Run Operational Gate (PR profile)
        shell: powershell
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -File scripts\run_ci_operational_gate.ps1 -IncludeBacktest

      - name: Generate Profitability Exploratory Report (Non-blocking)
        if: always()
        continue-on-error: true
        shell: powershell
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -File scripts\run_profitability_exploratory.ps1

      - name: Upload Gate Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-gate-reports
          path: |
            build/Release/logs/*.json
            build/Release/logs/*.csv
            build/Release/logs/*.log
            build/Release/state/*.json
            build/Release/state/*.jsonl
